<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Controlled generation with closure gating | VSAVM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/site.css">
  </head>
  <body>
    <div class="site">
      <header class="header">
        <div class="brand">VSAVM</div>
        <nav class="nav">
          <a href="../index.html">Home</a>
          <a href="../specs/">Specs</a>
          <a href="../theory/index.html">Theory</a>
          <a href="../wiki/index.html">Wiki</a>
        </nav>
      </header>
      <main class="main content">
        <h1>Controlled generation with closure gating</h1>
<p>This page is a theory note. It expands the topic in short chapters and defines terminology without duplicating the formal specification documents.</p><p>The diagram has a transparent background and is intended to be read together with the caption and the sections below.</p>
<p>Related wiki pages: <a href="../wiki/vm.html">VM</a>, <a href="../wiki/event-stream.html">event stream</a>, <a href="../wiki/context-scope.html">context scope</a>, <a href="../wiki/bounded-closure.html">bounded closure</a>, <a href="../wiki/llm.html">LLM</a>, <a href="../wiki/macro-token.html">macro-unit</a>.</p>
<p>Related specs: <a href="../specs-viewer.html?doc=specs/DS004-correctness-bounded-closure.md">DS004</a>, <a href="../specs-viewer.html?doc=specs/DS010-emergent-separator-discovery.md">DS010</a>, <a href="../specs-viewer.html?doc=specs/DS011-generative-decoding.md">DS011</a>.</p>

<h2>Overview</h2>
<p>VSAVM does not treat generation as unconstrained continuation. “Generation” is split into two mechanisms:</p>
<ul>
  <li><strong>Surface realization (implemented)</strong>: render VM/closure results into text without introducing new claims.</li>
  <li><strong>Continuation proposals (experimental, DS011)</strong>: a learned macro-unit language model can propose bytes to continue a prompt, but proposals must respect budgets and (when VM state is available) claim validation.</li>
</ul>

<h2>Implemented today: rendering checked artifacts</h2>
<p>The default path for answering is: execute → close → render. The renderer is intentionally simple and deterministic so it cannot “invent” facts.</p>
<ol>
  <li><strong>VM produces a result</strong> containing <code>claims</code>, <code>mode</code> (strict/conditional/indeterminate), and optional trace references.</li>
  <li><strong>Claim gating</strong> selects which claims are allowed to be rendered (see <code>GenerationService</code> + <code>ClaimGate.filterClaims</code>).</li>
  <li><strong>Deterministic rendering</strong> converts each claim into text lines (see <code>ClaimRenderer</code>).</li>
  <li><strong>Mode adaptation</strong> prefixes or suppresses output in conditional/indeterminate modes (see <code>ModeAdapter</code> + <code>UncertaintyMarker</code>).</li>
  <li><strong>Audit hint</strong> appends a minimal trace note when traces exist (see <code>TraceExplainer</code>).</li>
</ol>

<h2>DS011 continuation: macro-units + budgets + validation</h2>
<p>DS011 defines an optional continuation loop built on <strong>macro-units</strong>: frequently occurring byte sequences discovered by compression (MDL). Macro-units are reversible: they expand deterministically into the original bytes.</p>
<p>The current implementation lives in <code>src/training/outer-loop/macro-unit-model.mjs</code> and is exercised by <code>eval_tinyLLM</code>. It is a byte-level model with:</p>
<ul>
  <li>Kneser–Ney smoothing and backoff over bounded n-gram orders</li>
  <li>Streaming training (<code>trainStream</code>) with pruning and optional sampling</li>
  <li>Time/token budgets (<code>budgetMs</code>, <code>maxTokens</code>)</li>
  <li>Repetition penalties and n-gram blocking to reduce degenerate loops</li>
</ul>

<h3>Step-by-step continuation loop</h3>
<ol>
  <li><strong>Collect context</strong>: take a bounded window of recent bytes (the prompt tail).</li>
  <li><strong>Optionally encode VM state</strong>: compute a deterministic conditioning signature (see <code>VMStateConditioner</code>).</li>
  <li><strong>Propose candidates</strong>: generate top-K macro-unit proposals (and keep a byte-level fallback).</li>
  <li><strong>Validate candidates</strong>: if VM state is available, pass each proposal through <code>ClaimGate.validateMacroUnit</code>.</li>
  <li><strong>Select next</strong>: choose the best remaining candidate under the decoding policy and budget.</li>
  <li><strong>Append bytes</strong> and repeat until budget or stop condition ends the loop.</li>
</ol>

<h2>Budgets and “thinking more”</h2>
<p>Budgets are explicit and user-controlled. Increasing a budget changes what the system is allowed to assert:</p>
<ul>
  <li><strong>Closure budgets (DS004)</strong> control how far the VM explores consequences (depth/steps/branches/time).</li>
  <li><strong>Continuation budgets (DS011)</strong> control how long the macro-unit model is allowed to run (time/tokens).</li>
</ul>
<p>In both cases, budget is not a cosmetic knob: it is the horizon of the non-contradiction promise.</p>

<h2>Why separators matter (DS010)</h2>
<p>Controlled generation depends on scope boundaries. DS010 discovers structural separators so facts, rules, and continuations remain localized to the current structural region instead of bleeding across unrelated regions.</p>
<figure class="diagram">
<img class="diagram-svg" src="../assets/svg/controlled-generation-diagram.svg" alt="controlled-generation diagram">
<figcaption>Generation is treated as proposal followed by verification: either render checked artifacts (default) or propose continuations that are budgeted and (when applicable) validated against VM claims.</figcaption>
</figure>
<h2>References</h2>
<p><a href="https://en.wikipedia.org/wiki/Beam_search">Beam search (Wikipedia)</a> <a href="https://en.wikipedia.org/wiki/Transitive_closure">Transitive closure (Wikipedia)</a> <a href="https://en.wikipedia.org/wiki/Verification_and_validation">Verification and validation (Wikipedia)</a> <a href="https://en.wikipedia.org/wiki/Natural_language_generation">Natural language generation (Wikipedia)</a></p>
      </main>
      <footer class="footer">
        VSAVM is an Axiologic Research experiment within the Achilles project. This static documentation is written in clear academic English for engineers.
      </footer>
    </div>
  </body>
</html>
